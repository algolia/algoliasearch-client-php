# PHP CircleCI 2.0 configuration file
#
# Check https://circleci.com/docs/2.0/language-php/ for more details
#
version: 2.1


executors:
  php-docker: # declares a reusable executor
    parameters:
      image:
        description: "Docker image"
        type: string
      version:
        description: "PHP version tag"
        type: string
    docker:
      - image: <<parameters.image>>:<<parameters.version>>

jobs:
  test:
    parameters:
      image:
        description: "Docker image"
        type: string
      version:
        description: "PHP version tag"
        type: string
      http_client:
        description: "PHP client"
        type: string

    executor:
      name: php-docker
      image: <<parameters.image>>
      version: <<parameters.version>>

    steps:
      - checkout

      - run: sudo apt update
      - run: |
          if [ "<<parameters.image>>" = "circleci/php" ]; then
              sudo docker-php-ext-install zip
          fi

      # Download and cache dependencies
      - restore_cache:
          keys:
            - composer-deps-<<parameters.version>>-{{ checksum "composer.json" }}
            # fallback to using the latest cache if no exact match is found
            #- composer-deps-

      - run: |
          if [ "<<parameters.version>>" != "8.0" ]; then
            composer install -n --prefer-dist
          else
            composer install -n --prefer-dist --ignore-platform-req=php
          fi

      - save_cache:
          key: composer-deps-<<parameters.version>>-{{ checksum "composer.json" }}
          paths:
            - ./vendor

      - run:
          name: Install PHP Client
          command: |
            if [ "<<parameters.http_client>>" == "default" ]
            then
               echo "Nothing to install, using default Algolia\AlgoliaSearch\Http\Php53HttpClient"
            else
              composer require <<parameters.http_client>>
            fi

      - run:
          name: Get API Key Dealer client
          command: wget https://alg.li/algolia-keys && chmod +x algolia-keys

      - run:
          name: Check code styles
          command: |
            if [ "<<parameters.version>>" != "8.0" ]; then
              vendor/bin/php-cs-fixer fix -v --dry-run
            fi

      - run:
          name: Patch PHPUnit tests
          command: |
            if [ "<<parameters.version>>" == "7.4" || "<<parameters.version>>" == "8.0" ]; then
              ./tests/apply-phpunit-patches.sh
            fi

      # Run tests with phpunit
      #
      # If the PR is open by an Algolia, we run all the tests
      # with the keys in the env variables
      # If the PR was open from a fork (community PR)
      # we get API keys from the API key dealer https://alg.li/api-key-dealer

      - run:
          name: Run tests
          command: |
            export CI_BUILD_NUM=$CIRCLE_BUILD_NUM
            if [ -z ${CIRCLE_PR_REPONAME+x} ]
            then
               php vendor/bin/phpunit
            else
              export CI_PROJ_USERNAME=$CIRCLE_PROJECT_USERNAME
              export CI_PROJ_REPONAME=$CIRCLE_PROJECT_REPONAME

              eval $(./algolia-keys export) && php vendor/bin/phpunit -v --testsuite Unit,Definition,Community
            fi

      - run:
          name: Autoloading without Composer
          command: |
            export CI_BUILD_NUM=$CIRCLE_BUILD_NUM
            if [ -z ${CIRCLE_PR_REPONAME+x} ]
            then
               php vendor/bin/phpunit
            else
              export CI_PROJ_USERNAME=$CIRCLE_PROJECT_USERNAME
              export CI_PROJ_REPONAME=$CIRCLE_PROJECT_REPONAME

              eval $(./algolia-keys export) && php tests/tests-no-composer.php
            fi


workflows:
  workflow:
    jobs:
      - test:
          name: "PHP 8.0 - Guzzle 7"
          image: cimg/php
          version: "8.0"
          http_client: guzzlehttp/guzzle:"^7.0"
      - test:
          name: "PHP 7.4 - Guzzle 7"
          image: cimg/php
          version: "7.4"
          http_client: guzzlehttp/guzzle:"^7.0"

      - test:
          name: "PHP 7.4 - Guzzle 6"
          image: cimg/php
          version: "7.4"
          http_client: guzzlehttp/guzzle:"^6.0"
      - test:
          name: "PHP 7.0 - Guzzle 6"
          image: circleci/php
          version: "7.0"
          http_client: guzzlehttp/guzzle:"^6.0"
      - test:
          name: "PHP 5.6 - Guzzle 6"
          image: cimg/php
          version: "5.6"
          http_client: guzzlehttp/guzzle:"^6.0"

      - test:
          name: "PHP 8.0 - Default client"
          image: cimg/php
          version: "8.0"
          http_client: default
      - test:
          name: "PHP 7.4 - Default client"
          image: cimg/php
          version: "7.4"
          http_client: default
      - test:
          name: "PHP 7.0 - Default client"
          image: circleci/php
          version: "7.0"
          http_client: default
      - test:
          name: "PHP 5.6 - Default client"
          image: cimg/php
          version: "5.6"
          http_client: default
